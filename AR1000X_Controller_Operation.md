# AR1000X 조종기 동작 원리 (요약)

이 문서는 `AR1000X_Main.ino` 기준으로 조종기 동작 흐름을 정리한 것입니다.

---


## Clarification (KO/EN)
KO: "?? ???"? **PID ??(?? ?)? ???**? ????, **??? ??? ??**???.  
EN: "Drone initialization" means **resetting PID tuning only**, while **binding data is preserved**.

---

## 1. 시스템 개요
- MCU: RP2040 계열
- RF: nRF24L01 (250kbps, AutoAck 사용)
- FHSS(호핑) 사용: `HOP_MAX=12`
- 페어링/링크 셋업 채널: `PAIR_CHANNEL=76`
- 조종기 이름: `CTRL_NAME="AF1000X"` (8바이트)

---

## 2. 부팅 시 동작
1. **GPIO14 상태로 모드 결정**
   - 눌림(LOW) → `MODE1`
   - 아니면 → `MODE2`

2. **RF 초기화**
   - `PAIR_CHANNEL`로 초기 설정
   - 250kbps 데이터레이트, PA LOW

3. **호핑 테이블 준비 (옵션 A 동작)**
   - EEPROM에 저장된 테이블이 있으면:
     - **즉시 그 테이블로 조종 신호 송신**
     - 동시에 **새로운 호핑 테이블을 스캔**해 `nextHopTable`로 보관
   - EEPROM에 저장된 테이블이 없으면:
     - 스캔한 테이블을 바로 사용

4. **부팅 중 버튼(GPIO15) 눌림이면 페어링**
   - LinkPayload(조종기 이름 + 주소 + 호핑 테이블) 전송
   - 성공 시 `linkReady = true`

---

## 3. 링크 셋업 (배경 갱신)
- `linkReady == false`인 동안, **500ms 간격**으로 LinkPayload를 전송
- 드론이 ACK하면:
  - **새로운 호핑 테이블로 스왑**
  - EEPROM 저장 예약
  - 이후는 정상 조종

즉, **기존 테이블로 즉시 조종 가능하면서**
**새 테이블로 점진적으로 갱신**하는 구조입니다.

---

## 4. 조종 입력 처리 (스틱/버튼)
1. **스틱 입력**
2. **트림**
3. **헤드리스**
4. **스피드 단계**
5. **자동 이륙/착륙**
6. **긴급 정지**

설명
- 스틱 입력은 MODE1/ MODE2 설정에 따라 매핑됩니다.
- 트림 모드에서는 현재 스틱 위치를 기준으로 롤/피치 오프셋이 저장됩니다.
- 헤드리스는 AUX2 플래그로 전달됩니다.
- 스피드 모드는 1~3 단계이며 스틱/PC에 동일하게 적용됩니다.
- 자동 이륙/착륙은 AUX1 펄스로 전달됩니다.
- 긴급 정지는 모터 컷을 위한 안전 신호를 즉시 송신합니다.

---

## 5. PC 제어 모드 (USB 시리얼)
PC 제어는 **ARM 이후에만 허용**됩니다.

핵심 동작
- `ARM 1` 이후에만 PC 명령이 유효
- 스틱이 움직이면 즉시 PC 제어 해제
- `JOY` 스트림이 200ms 이상 끊기면 스틱으로 복귀

자세한 명령 목록은 `AR1000X_Serial_Command_Reference.md` 참고

---

## 6. LED 동작 요약
- LED1: 전원/바인딩/저전압 상태 표시
- LED2: 헤드리스 모드 표시
- LED3: 트림 모드 표시

---

## 7. 배터리 모니터링
- 1초마다 배터리 전압 측정
- 저전압 시 LED1 빠른 점멸

---

## 8. 페어링/바인딩 정책
- 자동 바인딩 없음
- **GPIO15를 누른 상태에서만 페어링**
- 또는 `BIND` / `PAIR` 시리얼 명령으로만 수행

---

## 9. 주파수 / 호핑 범위
- 채널 범위: `2405MHz ~ 2480MHz` (채널 5~80)
- 사용 채널 수: `HOP_MAX=12`
- RPD 스캔으로 혼잡도가 낮은 채널 우선 선택

---

## 10. 재연결 시나리오 (옵션 A)
1. 조종기 재부팅 직후에도 **이전 테이블로 즉시 송신**
2. 드론이 살아있는 경우, **즉시 제어 복구**
3. 동시에 새 테이블을 전송하여 혼잡 회피 갱신

---

필요하면 이 문서를 더 상세한 설계 문서 형식으로 확장할 수 있어요.
